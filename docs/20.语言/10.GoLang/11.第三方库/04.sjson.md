---
title: sjson
date: 2023-02-04 14:53:25
permalink: /language/go/d5711b/
categories:
  - 语言
  - GoLang
  - 第三方库
tags:
  - 
---

## `gjson`库简介

`SJSON`是一个`Go`包，它提供了一种在`json`文档中设置值的非常快速和简单的方法。要快速检索`json`值，请查看[`GJSON`](/language/go/d3c5fd/)。

<!-- more -->

<InArticleAdsense
    data-ad-client="ca-pub-1725717718088510"
    data-ad-slot="7426219401">
</InArticleAdsense>

## 开源库地址

[tidwall/sjson: Set JSON values very quickly in Go](https://github.com/tidwall/sjson)

## 快速使用

### 安装

``` shell
go get github.com/tidwall/sjson
```

### 使用

``` go
package main

import (
  "fmt"

  "github.com/tidwall/sjson"
)

const json = `{"name":{"first":"li","last":"dj"},"age":18}`

func main() {
  value, _ := sjson.Set(json, "name.last", "dajun")
  fmt.Println(value)
}
```

上面代码通过`sjson.Set()`将`JSON`串中`name.last`对应的值设置为`dajun`。与`gjson`一样，`sjson`也通过键路径指定具体的位置，键路径即为一系列以`.`分隔的键。`sjson`支持的键路径语法是`gjson`的一个子集，具体键路径的语法可以参见上一篇文章。`sjson.Set()`返回设置之后的`JSON`串。最终程序输出：

``` json
{
    "name": {
        "first": "li",
        "last": "dajun"
    },
    "age": 18
}
```

## 支持的类型

`sjson`支持的类型包括`nil/bool/int/float/string`等。如果传入`sjson`不支持的类型，`sjson`会调用`json.Marshal`，然后将生成的字符串设置到对应的键路径上：

``` go
type User struct {
  Name string `json:"name"`
  Age  int    `json:"age"`
}

func main() {
  nilJSON, _ := sjson.Set("", "key", nil)
  fmt.Println(nilJSON)

  boolJSON, _ := sjson.Set("", "key", false)
  fmt.Println(boolJSON)

  intJSON, _ := sjson.Set("", "key", 1)
  fmt.Println(intJSON)

  floatJSON, _ := sjson.Set("", "key", 10.5)
  fmt.Println(floatJSON)

  strJSON, _ := sjson.Set("", "key", "hello")
  fmt.Println(strJSON)

  mapJSON, _ := sjson.Set("", "key", map[string]interface{}{"hello": "world"})
  fmt.Println(mapJSON)

  u := User{Name: "dj", Age: 18}
  structJSON, _ := sjson.Set("", "key", u)
  fmt.Println(structJSON)
}
```

注意，我们传入一个空字符串，`sjson.Set()`会生成一个空对象，然后按照键路径依次设置值。下面分析上述程序输出：

- `nil`：在`JSON`中用`null`表示，输出`{"key":null}`；

- `false`：在`JSON`中布尔值用`true/false`表示，输出`{"key":false}`；

- `1`和`10.5`：整数和浮点数在`JSON`中都用`number`表示，分别输出`{"key":1}`和`{"key":10.5}`；

- `hello`：输出`{"key":"hello"}`；

- `map[string]interface{}`：`sjson`并不原生支持`map`类型，故通过`json.Marshal`将其序列化为`{"hello":"world"}`再设置到键`key`上，输出`{"key":{"hello":"world"}}`；

- `User`对象：先通过`json.Marshal`序列化为`{"name":"dj","age":18}`再设置；

## 实战

### 将多层`json`转换成单层`json`

``` go
jsonStr := `
{
    "重庆": {
        "重庆": "1"
    },
    "陕西": {
        "宝鸡": "2",
        "榆林": "3",
        "铜川": "4"
    },
    "内蒙古": {
        "呼和浩特": "5",
        "巴彦淖尔": "6"
    },
    "安徽": {
        "宿州": "7",
        "芜湖": "8"
    }
}
`
// 用于装载json的map
jsonMap := make(map[string]interface{})
// 将json数据转换为json对象
json.Unmarshal([]byte(jsonStr), &jsonMap)

newJsonStr := ""
for _, provinceCity := range jsonMap {
	for cityName, cityCode := range provinceCity.(map[string]interface{}) {
		newJsonStr, _ = sjson.Set(newJsonStr, cityName, cityCode)
	}
}
fmt.Println(newJsonStr)
```

输出

``` json
{
    "重庆": "1",
    "宝鸡": "2",
    "榆林": "3",
    "铜川": "4",
    "呼和浩特": "5",
    "巴彦淖尔": "6",
    "宿州": "7",
    "芜湖": "8"
}
```

## 注意事项

1. 如果想把`json`字符串加入到某个节点下，`json`字符串的`"`会被转译变成`\"`，此问题暂时无解